name: Deploy to GCP Cloud Run

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPOSITORY: cineior-repo

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Ensure Artifact Registry exists
        run: |
          echo "Checking if repository ${REPOSITORY} exists..."
          gcloud artifacts repositories describe ${REPOSITORY} --location=${REGION}


  deploy:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [auth-service, movie-service, user-service, api-gateway]
        include:
          - service: auth-service
            folder: backend/auth-service
            port: 8081
          - service: movie-service
            folder: backend/movie-service
            port: 8082
          - service: user-service
            folder: backend/user-service
            port: 8083
          - service: api-gateway
            folder: backend/api-gateway
            port: 8080

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build Container
        run: |
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${{ matrix.service }}:${{ github.sha }}"
          echo "Building image: $IMAGE_NAME"
          # Using --no-cache to ensure a clean build for troubleshooting
          docker build --no-cache -t $IMAGE_NAME ${{ matrix.folder }}

      - name: Push Container
        run: |
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${{ matrix.service }}:${{ github.sha }}"
          echo "Pushing image: $IMAGE_NAME"
          docker push $IMAGE_NAME

      - name: Deploy to Cloud Run
        run: |
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${{ matrix.service }}:${{ github.sha }}"
          echo "Deploying to Cloud Run: ${{ matrix.service }}"
          gcloud run deploy ${{ matrix.service }} \
            --image $IMAGE_NAME \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --max-instances 1 \
            --port ${{ matrix.port }} \
            --set-env-vars "SPRING_PROFILES_ACTIVE=prod" \
            --set-env-vars "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" \
            --set-env-vars "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" \
            --set-env-vars "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" \
            --set-env-vars "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" \
            --set-env-vars "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" \
            --set-env-vars "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --set-env-vars "AUTH_SERVICE_URL=${{ secrets.AUTH_SERVICE_URL }}" \
            --set-env-vars "MOVIE_SERVICE_URL=${{ secrets.MOVIE_SERVICE_URL }}" \
            --set-env-vars "USER_SERVICE_URL=${{ secrets.USER_SERVICE_URL }}"
