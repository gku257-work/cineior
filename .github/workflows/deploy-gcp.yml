name: Deploy to GCP Cloud Run

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPOSITORY: cineior-repo

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [auth-service, movie-service, user-service, api-gateway]
        include:
          - service: auth-service
            folder: backend/auth-service
            port: 8081
          - service: movie-service
            folder: backend/movie-service
            port: 8082
          - service: user-service
            folder: backend/user-service
            port: 8083
          - service: api-gateway
            folder: backend/api-gateway
            port: 8080

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Enable GCP APIs
        run: |
          gcloud services enable artifactregistry.googleapis.com run.googleapis.com --quiet

      - name: Ensure Artifact Registry exists
        run: |
          if ! gcloud artifacts repositories describe ${REPOSITORY} --location=${REGION} &>/dev/null; then
            echo "Creating repository ${REPOSITORY}..."
            gcloud artifacts repositories create ${REPOSITORY} \
              --repository-format=docker \
              --location=${REGION} \
              --description="Docker repository for Cineior services"
          fi

      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build Container
        run: |
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${{ matrix.service }}:${{ github.sha }}"
          echo "Building image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME ${{ matrix.folder }}

      - name: Push Container
        run: |
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${{ matrix.service }}:${{ github.sha }}"
          echo "Pushing image: $IMAGE_NAME"
          docker push $IMAGE_NAME

      - name: Deploy to Cloud Run
        run: |
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${{ matrix.service }}:${{ github.sha }}"
          echo "Deploying to Cloud Run: ${{ matrix.service }}"
          gcloud run deploy ${{ matrix.service }} \
            --image $IMAGE_NAME \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --max-instances 1 \
            --port ${{ matrix.port }} \
            --set-env-vars "SPRING_PROFILES_ACTIVE=prod"
